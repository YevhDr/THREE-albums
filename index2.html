<!DOCTYPE html>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>THREE.JS</title>

<link rel='stylesheet' href="https://rawgit.com/domitry/elegans/master/examples/common.css">
<!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r66/three.min.js"></script>-->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.4/d3.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>

<style>
    body {
        margin: 0;
    }
    #vis {
        width: 100vw;
        height: 100vh;
        display: block;
    }

</style>

<body>

<div id="container"></div>
<canvas id="vis"></canvas>
<div id='tooltip' style='visibility: visible; position: absolute; top: 10px; left: 10px; color: white; font-family:sans-serif'></div>

<script type="module">
    import * as THREE from 'https://threejsfundamentals.org/threejs/resources/threejs/r110/build/three.module.js';
    import {OrbitControls} from 'https://threejsfundamentals.org/threejs/resources/threejs/r110/examples/jsm/controls/OrbitControls.js';


    // --- cleaning console --- //
    console.clear();

    // --- threeJS --- //
    var renderer, scene, projector;

    //var container = document.getElementById('container');
    const canvas = document.querySelector('#vis');
    var w = 1800;
    var h = 880;
    const fov = 50;
    const aspect = 4;  // the canvas default
    const near = 1;
    const far = 500;
    const camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
    const controls = new OrbitControls(camera, canvas);
    //var distance = 400;




    var raycaster = new THREE.Raycaster();
    var INTERSECTED;
    var mouse = new THREE.Vector2();

    var diamondsGroup = new THREE.Object3D();
    var spheres = new THREE.Object3D();


    camera.position.set(0, 0, -600);
    controls.update();
    var colour = d3.scale.category20c();

    function hexToRgb(hex) { //TODO rewrite with vector output
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

    function resizeRendererToDisplaySize(renderer) {
        const canvas = renderer.domElement;
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        const needResize = canvas.width !== width || canvas.height !== height;
        if (needResize) {
            renderer.setSize(width, height, false);
        }
        return needResize;
    }


    var src = "img/pic.jpg";

    var mat = new THREE.PointsMaterial({
        //blending: THREE.AdditiveBlending,
        //map: new THREE.TextureLoader().load(src),
        //transparent: false,
        //depthWrite: false,
        vertexColors: true,
        size: 10
    });

    // -- basic initialization -- //
    function init() {
        renderer = new THREE.WebGLRenderer({canvas });
        renderer.autoClearColor = false;
        renderer.setSize(window.innerWidth, window.innerHeight);
        //renderer.setClearColor(0x140b33, 1);
        //container.appendChild(renderer.domElement);

        scene = new THREE.Scene();



        //scene.add(camera);

//        var light = new THREE.PointLight(0xffffff, 1, 4000);
//        light.position.set(50, 0, 0);
//        var light_two = new THREE.PointLight(0xffffff, 1, 4000);
//        light_two.position.set(-100, 800, 800);
//        var lightAmbient = new THREE.AmbientLight(0x404040);
//        scene.add(light, light_two, lightAmbient);

        createDiamond();



        renderer.render(scene, camera);

//        document.addEventListener('mousemove', onMouseMove, false);
//        document.addEventListener('mousedown', onDocumentMouseDown, false);
//        window.addEventListener('resize', onWindowResize, false);
    }

    // -- diamonds -- //
    function createDiamond() {

        var arr = ['http://topotopo.io/',
            'https://panic.com/transmit/',
            'http://www.larsberg.net/',
            'http://www.robertadicamerino.com/',
            'https://tonite.dance/',
            'https://moments.epic.net/',
            'http://www.welcometofillory.com/map',
            'http://www.veilhymn.com/',
            'http://swissarmyman.com/',
            'https://aframe.io/',
            'http://www.dennis.video/',
            'http://a-way-to-go.com/',
            'http://www.simonreeves.com/projects/db5/'
        ];

        //const geometry = new THREE.PlaneGeometry(1, 0.5, 1 );
        //const geometry = new THREE.Geometry();

//        var loader = new THREE.JSONLoader();
//        loader.load('https://raw.githubusercontent.com/PavelLaptev/test-rep/master/threejs-post/diamond.json', function(geometry) {
            d3.csv("data/testData.csv", function (data) {

                var xExent = d3.extent(data, function (d) {return d.x; }),
                    yExent = d3.extent(data, function (d) {return d.y; }),
                    zExent = d3.extent(data, function (d) {return d.z; });

                var colour = d3.scale.category20c();
                var xScale = d3.scale.linear()
                        .domain(xExent)
                        .range([-50,50]);
                var yScale = d3.scale.linear()
                        .domain(yExent)
                        .range([-50,50]);
                var zScale = d3.scale.linear()
                        .domain([0, 1000])
                        .range([-500,500]);
                var color = new THREE.Color();

                data.forEach(function (d, i) {
                    const geometry = new THREE.PlaneGeometry(1, 0.5, 1 );

//                    var coords = [];
//                    var colors = [];
//                    let vx = hexToRgb(colour(i)).r / 255;
//                    let vy = hexToRgb(colour(i)).g / 255;
//                    let vz = hexToRgb(colour(i)).b / 255;
//                    color.setRGB( vx, vy, vz );
//                    colors.push( color.r, color.g, color.b );
//
//                    var x = xScale(Math.random() * 500);
//                    var y = yScale(+d.y);
//                    var z = zScale(Math.random() * 500);
//
//                    geometry.vertices.push(new THREE.Vector3(x, y, z));
//                    geometry.colors.push(new THREE.Color().setRGB(hexToRgb(colour(i)).r / 255, hexToRgb(colour(i)).g / 255, hexToRgb(colour(i)).b / 255));

                    var material = new THREE.MeshPhongMaterial({
                        color: Math.random() * 0xff00000 - 0xff00000,
                        //color: color.setRGB( vx, vy, vz ),
                        shading: THREE.FlatShading
                    });

                    //var diamond = new THREE.Points(geometry, material);
                    var diamond = new THREE.Mesh(geometry, material);
                    diamond.position.x = Math.random() * 500;
                    diamond.position.y = Math.random() * 500;
                    diamond.position.z = Math.random() * 500;

//                    diamond.position.x = xScale(Math.random() * 500);
//                    diamond.position.y = yScale(+d.y);
//                    diamond.position.z = zScale(Math.random() * 500);
                    //diamond.rotation.y = Math.random() * 2 * Math.PI;
                    //diamond.scale.x = diamond.scale.y = diamond.scale.z = Math.random() * 50 + 10;

                    diamond.userData = {
                        URL: arr[Math.floor(Math.random() * arr.length)], artist: d.artist
                    };

                    diamondsGroup.add(diamond);
                });
            });
            diamondsGroup.position.y = 0;
            scene.add(diamondsGroup);
//        });
    }



    // -- events -- //
//    function onMouseMove(event) {
//        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
//        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
//        var mouseX = event.clientX - window.innerWidth / 2;
//        var mouseY = event.clientY - window.innerHeight / 2;
//        //camera.position.x += (mouseX - camera.position.x) * 0.01;
//        //camera.position.y += (mouseY - camera.position.y) * 0.01;
//        //camera.lookAt(scene.position);
//    }

//    function onDocumentMouseDown(event) {
//
//        event.preventDefault();
//        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
//        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
//
//        raycaster.setFromCamera(mouse, camera);
//
//        var intersects = raycaster.intersectObjects(diamondsGroup.children);
//        if (intersects.length > 0) {
//            window.open(intersects[0].object.userData.URL);
//        }
//
//    }

//    function onWindowResize() {
//        camera.aspect = window.innerWidth / window.innerHeight;
//        renderer.setSize(window.innerWidth, window.innerHeight);
//        camera.updateProjectionMatrix();
//    }

    // ---- //
    function animate() {
        requestAnimationFrame(animate);
        render();
    }





    // -- render all -- //
    function render() {

        //var timer = 0.00001 * Date.now();

//        for (let i = 0, l = diamondsGroup.children.length; i < l; i++) {
////            let object = diamondsGroup.children[i];
////            object.position.y = 500 * Math.cos(timer + i);
////            object.rotation.y += Math.PI / 500;
//        }
//
//        for (let i = 0, l = spheres.children.length; i < l; i++) {
////            let object = spheres.children[i];
////            object.rotation.y += Math.PI / 60;
////            if (i < 20) {
////                object.rotation.y -= Math.PI / 40;
////            }
//        }

        // update the picking ray with the camera and mouse position
//        raycaster.setFromCamera(mouse, camera);
//
//        // calculate objects intersecting the picking ray
//        var intersects = raycaster.intersectObjects(diamondsGroup.children);
//
//        if (intersects.length > 0) {
//            if (INTERSECTED != intersects[0].object) {
//                //if (INTERSECTED) INTERSECTED.material.emissive.setHex(INTERSECTED.currentHex);
//                INTERSECTED = intersects[0].object;
//                console.log(INTERSECTED);
//                //INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
//
//                //INTERSECTED.material.color.setHex(Math.random() * 0xff00000 - 0xff00000);
//            }
//        } else {
////            if (INTERSECTED) INTERSECTED.material.emissive.setHex(Math.random() * 0xff00000 - 0xff00000);
////            INTERSECTED = null;
//        }

        renderer.render(scene, camera);

        requestAnimationFrame(render);

    }

    // -- run functions -- //
    init();
    animate();


</script>
</body>
